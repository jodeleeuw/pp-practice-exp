<!DOCTYPE html>
<html>
<head>
  <script src="jspsych-6.1-beta/jspsych.js"></script>
  <script src="jspsych-6.1-beta/plugins/jspsych-html-button-response.js"></script>
  <script src="custom_plugins/jspsych-memory-quiz.js"></script>
  <script src="custom_plugins/jspsych-dialog.js"></script>
  <script src="custom_plugins/jspsych-dialog-video.js"></script>
  <link rel="stylesheet" type="text/css" href="jspsych-6.0.3/css/jspsych.css"></link>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <script src="js/serverComm.js"></script>
  <style>

  .dialog-btn {
    background: #FFA500;
    color: white;
    border-radius: 4px;
    padding: 12px 24px;
    border-style: none;
    cursor: pointer;
    /*box-shadow: 0 1px 1px 0 rgba(0,0,0,0.5);*/
  }

  .dialog-btn:hover {
    background: #FF8C00;
  }
  </style>
</head>
<body>
</body>
<script>

// get subject ID
var pid = jsPsych.data.getURLVariable('prolific_pid');
if(pid == "" || pid == null || pid == undefined){
  pid = 'NO_PROLIFIC_' + jsPsych.randomization.randomID(20);
}

jsPsych.data.addProperties({
  phase: 'testing',
  participant_id: pid
});

var word_pairs = [
  {cue:"money", target: "velvet"},
  {cue:"robber", target: "stairway"},
  {cue:"college", target: "pest"},
  {cue:"body", target: "stripe"},
  {cue:"hand", target: "holiday"},
  {cue:"glacier", target: "cylinder"},
  {cue: "linen", target:"rock"},
  {cue: "moss", target:"binder"},
  {cue: "coral", target:"charm"},
  {cue: "parcel", target:"history"},
  {cue: "monarch", target:"viola"},
  {cue: "tornado", target:"widow"},
  {cue: "school", target:"rabbit"},
  {cue: "machine", target:"havoc"},
  {cue: "morning", target:"roost"},
  {cue: "witch", target:"onion"},
  {cue: "walrus", target:"ditch"},
  {cue: "carrot", target:"mold"},
  {cue: "bacteria", target:"wand"},
  {cue: "room", target:"tomb"},
  {cue: "clown", target:"chlorine"},
  {cue: "emerald", target:"medicine"},
  {cue: "radio", target:"oval"},
  {cue: "land", target:"base"},
  {cue: "pliers", target:"reserve"},
  {cue: "road", target:"song"},
  {cue: "test", target:"seam"},
  {cue: "horse", target:"vanity"},
  {cue: "vest", target:"expert"},
  {cue: "sponge", target:"potatoes"},
  {cue: "house", target:"illness"},
  {cue: "hostage", target:"deputy"}
];

var timeline = [];

var welcome = {
  type: 'dialog',
  max_width: 600,
  stimulus: '<p>Welcome back! We are still using audio instructions. Please make sure that your sound is on and at a comfortable volume.</p>',
  choices: ['I\'m ready to start'],
  button_html: '<button class="dialog-btn">%choice%</button>',
  post_trial_gap: 250,
  on_start: function(){
    var bg_style = "<style>body {background: repeating-linear-gradient( 90deg, hsla(232, 41%, 56%, 1), hsla(232, 41%, 56%, 1) 3px, hsla(232, 41%, 60%, 1) 3px, hsla(232, 41%, 60%, 1) 18px)</style>";
    document.querySelector('head').insertAdjacentHTML('beforeend', bg_style);
  }
}

timeline.push(welcome);

var pre_test = {
  type: 'dialog-video',
  stimulus: 'video/clip7.mp4',
  post_trial_gap: 1000
}

timeline.push(pre_test);

var test_phase_stimuli = jsPsych.randomization.shuffle(jsPsych.utils.deepCopy(word_pairs));

for(var i=0; i<test_phase_stimuli.length; i++){
  timeline.push({
    type: 'memory-quiz',
    cue: test_phase_stimuli[i].cue,
    target: test_phase_stimuli[i].target,
    display: 'test',
    study_duration: 1000, // irrelevant for this phase
    shiny: false,
    slide_in: i == 0 ? true : false,
    show_feedback: true,
    correct_sound: 'audio/correct.mp3',
    incorrect_sound: 'audio/incorrect.mp3',
    question_number: i+1,
    total_questions: test_phase_stimuli.length,
    next_cue: i < test_phase_stimuli.length-1 ? test_phase_stimuli[i+1].cue : '',
    next_target: i < test_phase_stimuli.length-1 ? test_phase_stimuli[i+1].target : '',
    next_display: 'test',
    next_shiny: false
  })
}

var post_test = {
  type: 'dialog',
  stimulus: function(){
    var numCorrect = jsPsych.data.get().filter({trial_type: 'memory-quiz', correct: true}).count();
    var numTotal = jsPsych.data.get().filter({trial_type: 'memory-quiz'}).count();
    return '<p>You remembered '+numCorrect+' out of '+numTotal+'.</p><p>All done!</p>'
  },
  button_html: '<button class="dialog-btn">%choice%</button>',
  choices: ["Bye!"],
  post_trial_gap: 1000,
  on_start: function(){
    var all_data = jsPsych.data.get().values();
    serverComm.save_data(all_data);
  }
}

timeline.push(post_test);

var return_to_prolific = {
  type: 'dialog',
  stimulus: '<p><a href="#">Click here</a> to return to Prolific and complete the study.</p><p>You do not need a completion code.</p>',
  button_html: '<button class="dialog-btn">%choice%</button>',
  max_width: 900,
  choices: [],
  post_trial_gap: 1000
}

timeline.push(return_to_prolific);

jsPsych.init({
  timeline: timeline,
  use_webaudio: false
})

</script>
</html>
